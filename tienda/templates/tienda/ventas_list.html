{% extends 'tienda/base.html' %}
{% load humanize %}

{% block title %}Historial de Ventas{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">

  <!-- Header & Actions -->
  <div class="d-flex justify-content-between align-items-center mb-4 animate__animated animate__fadeInDown">
    <div>
      <h2 class="fw-bold text-main mb-1">Historial de Ventas</h2>
      <p class="text-muted mb-0">Gestiona y visualiza todas las transacciones</p>
    </div>
    <a href="{% url 'ventas_create' %}" class="btn btn-primary btn-lg shadow-lg d-flex align-items-center gap-2"
      style="border-radius: 50px; padding: 0.8rem 1.5rem;">
      <i class="fas fa-plus-circle"></i>
      <span>Nueva Venta</span>
    </a>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-5 animate__animated animate__fadeInUp">
    <!-- Total Ventas -->
    <div class="col-md-3">
      <div class="glass-card p-4 h-100 position-relative overflow-hidden">
        <div class="position-absolute top-0 end-0 p-3 opacity-10">
          <i class="fas fa-shopping-bag fa-4x text-primary"></i>
        </div>
        <div class="d-flex flex-column position-relative z-1">
          <span class="text-muted text-uppercase small fw-bold mb-2">Total Ventas</span>
          <h3 class="text-main fw-bold mb-0">{{ total_ventas_count }}</h3>
          <span class="text-success small mt-2"><i class="fas fa-arrow-up me-1"></i>Histórico</span>
        </div>
      </div>
    </div>

    <!-- Ingresos Totales -->
    <div class="col-md-3">
      <div class="glass-card p-4 h-100 position-relative overflow-hidden">
        <div class="position-absolute top-0 end-0 p-3 opacity-10">
          <i class="fas fa-wallet fa-4x text-success"></i>
        </div>
        <div class="d-flex flex-column position-relative z-1">
          <span class="text-muted text-uppercase small fw-bold mb-2">Ingresos Totales</span>
          <h3 class="text-main fw-bold mb-0"
            style="background: linear-gradient(to right, var(--success), #2bdaca); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
            ${{ total_ingresos|floatformat:0|intcomma }}
          </h3>
          <span class="text-success small mt-2"><i class="fas fa-chart-line me-1"></i>Acumulado</span>
        </div>
      </div>
    </div>

    <!-- Ventas Hoy -->
    <div class="col-md-3">
      <div class="glass-card p-4 h-100 position-relative overflow-hidden">
        <div class="position-absolute top-0 end-0 p-3 opacity-10">
          <i class="fas fa-calendar-day fa-4x text-info"></i>
        </div>
        <div class="d-flex flex-column position-relative z-1">
          <span class="text-muted text-uppercase small fw-bold mb-2">Ventas Hoy</span>
          <h3 class="text-main fw-bold mb-0">{{ ventas_hoy_count }}</h3>
          <span class="text-info small mt-2">
            {% if ventas_hoy_count > 0 %}
            <i class="fas fa-check-circle me-1"></i>Actividad reciente
            {% else %}
            <i class="fas fa-clock me-1"></i>Esperando ventas
            {% endif %}
          </span>
        </div>
      </div>
    </div>

    <!-- Ingresos Hoy -->
    <div class="col-md-3">
      <div class="glass-card p-4 h-100 position-relative overflow-hidden">
        <div class="position-absolute top-0 end-0 p-3 opacity-10">
          <i class="fas fa-coins fa-4x text-warning"></i>
        </div>
        <div class="d-flex flex-column position-relative z-1">
          <span class="text-muted text-uppercase small fw-bold mb-2">Ingresos Hoy</span>
          <h3 class="text-main fw-bold mb-0 text-warning">
            ${{ ingresos_hoy|floatformat:0|intcomma }}
          </h3>
          <span class="text-warning small mt-2"><i class="fas fa-bolt me-1"></i>Hoy</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Search & Filter -->
  <div class="row mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
    <div class="col-12">
      <div class="glass-effect p-2 rounded-pill d-flex align-items-center ps-4 pe-2 shadow-sm"
        style="border: 1px solid var(--border-color);">
        <i class="fas fa-search text-muted me-3"></i>
        <input type="text" id="filtroVentas" class="form-control bg-transparent border-0 text-main shadow-none"
          placeholder="Buscar por cliente, vendedor, ID..." style="font-size: 1.1rem;">
        <div class="dropdown">
          <button class="btn btn-dark rounded-pill px-4" type="button">
            <i class="fas fa-filter me-2"></i>Filtrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sales Table -->
  <div class="glass-card rounded-4 overflow-hidden shadow-lg animate__animated animate__fadeInUp"
    style="animation-delay: 0.2s;">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" style="border-collapse: separate; border-spacing: 0;">
        <thead class="bg-light bg-opacity-10">
          <tr>
            <th
              class="ps-4 py-3 text-uppercase small fw-bold text-muted border-bottom border-secondary border-opacity-10">
              ID</th>
            <th class="py-3 text-uppercase small fw-bold text-muted border-bottom border-secondary border-opacity-10">
              Cliente</th>
            <th class="py-3 text-uppercase small fw-bold text-muted border-bottom border-secondary border-opacity-10">
              Fecha</th>
            <th class="py-3 text-uppercase small fw-bold text-muted border-bottom border-secondary border-opacity-10">
              Vendedor</th>
            <th class="py-3 text-uppercase small fw-bold text-muted border-bottom border-secondary border-opacity-10">
              Productos</th>
            <th class="py-3 text-uppercase small fw-bold text-muted border-bottom border-secondary border-opacity-10">
              Pago</th>
            <th
              class="text-end py-3 text-uppercase small fw-bold text-muted border-bottom border-secondary border-opacity-10">
              Total</th>
            <th
              class="text-end pe-4 py-3 text-uppercase small fw-bold text-muted border-bottom border-secondary border-opacity-10">
              Acciones</th>
          </tr>
        </thead>
        <tbody id="ventasBody">
          {% for venta in ventas %}
          <tr class="venta-row transition-hover" data-cliente="{{ venta.cliente.nombre|lower }}"
            data-vendedor="{{ venta.vendedor.username|lower }}" data-id="{{ venta.pk }}">

            <td class="ps-4 py-3 border-bottom border-secondary border-opacity-10">
              <span class="badge bg-secondary bg-opacity-10 text-main fw-normal font-monospace">#{{ venta.pk }}</span>
            </td>

            <td class="py-3 border-bottom border-secondary border-opacity-10">
              <div class="d-flex align-items-center">
                <div class="avatar-circle me-3 bg-gradient-primary text-white shadow-sm">
                  {{ venta.cliente.nombre|first|upper }}
                </div>
                <div>
                  <div class="fw-bold text-main">{{ venta.cliente.nombre }}</div>
                  <div class="small text-muted">Cliente Frecuente</div>
                </div>
              </div>
            </td>

            <td class="py-3 border-bottom border-secondary border-opacity-10">
              <div class="d-flex flex-column">
                <span class="fw-medium text-main">{{ venta.fecha|date:"d M, Y" }}</span>
                <span class="small text-muted">{{ venta.fecha|time:"H:i" }}</span>
              </div>
            </td>

            <td class="py-3 border-bottom border-secondary border-opacity-10">
              <div class="d-flex align-items-center gap-2">
                <i class="fas fa-user-tie text-muted"></i>
                <span class="text-muted">{{ venta.vendedor.username|title }}</span>
              </div>
            </td>

            <td class="py-3 border-bottom border-secondary border-opacity-10">
              <div class="d-flex flex-wrap gap-1" style="max-width: 200px;">
                {% for item in venta.items.all|slice:":2" %}
                <span
                  class="badge bg-secondary bg-opacity-10 text-muted border border-secondary border-opacity-10 fw-normal">
                  {{ item.producto.nombre|truncatechars:15 }} <span class="text-main">x{{ item.cantidad }}</span>
                </span>
                {% endfor %}
                {% if venta.items.all.count > 2 %}
                <span class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-25">
                  +{{ venta.items.all.count|add:"-2" }} más
                </span>
                {% endif %}
              </div>
            </td>

            <td class="py-3 border-bottom border-secondary border-opacity-10">
              {% if venta.metodo_pago|lower == 'efectivo' %}
              <span
                class="badge bg-success bg-opacity-20 text-success border border-success border-opacity-25 px-3 py-2 rounded-pill">
                <i class="fas fa-money-bill-wave me-1"></i> Efectivo
              </span>
              {% elif venta.metodo_pago|lower == 'tarjeta' %}
              <span
                class="badge bg-info bg-opacity-20 text-info border border-info border-opacity-25 px-3 py-2 rounded-pill">
                <i class="fas fa-credit-card me-1"></i> Tarjeta
              </span>
              {% else %}
              <span
                class="badge bg-secondary bg-opacity-20 text-secondary border border-secondary border-opacity-25 px-3 py-2 rounded-pill">
                {{ venta.metodo_pago|default:"Otro" }}
              </span>
              {% endif %}
            </td>

            <td class="text-end py-3 border-bottom border-secondary border-opacity-10">
              <span class="fw-bold fs-5"
                style="background: linear-gradient(135deg, var(--text-main) 0%, var(--primary) 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                ${{ venta.total|floatformat:0|intcomma }}
              </span>
            </td>

            <td class="text-end pe-4 py-3 border-bottom border-secondary border-opacity-10">
              <div class="d-flex justify-content-end gap-2">
                <a href="{% url 'ventas_detalle' venta.pk %}" class="btn btn-icon btn-sm btn-glass text-primary"
                  title="Ver Detalle">
                  <i class="fas fa-eye"></i>
                </a>
                <a href="{% url 'ventas_factura_pdf_rl' venta.pk %}" class="btn btn-icon btn-sm btn-glass text-danger"
                  target="_blank" title="Descargar PDF">
                  <i class="fas fa-file-pdf"></i>
                </a>
                <a href="{% url 'ventas_delete' venta.pk %}" class="btn btn-icon btn-sm btn-glass text-secondary"
                  onclick="return confirm('¿Estás seguro de eliminar esta venta? Esta acción restaurará el stock.');"
                  title="Eliminar">
                  <i class="fas fa-trash-alt"></i>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-5">
              <div class="d-flex flex-column align-items-center justify-content-center opacity-50">
                <i class="fas fa-receipt fa-4x mb-3 text-muted"></i>
                <h5 class="text-muted">No hay ventas registradas</h5>
                <p class="text-muted">Comienza creando una nueva venta.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- No Results State -->
  <div id="sinResultados" class="text-center py-5 d-none">
    <div class="glass-card d-inline-block p-5 rounded-circle mb-3">
      <i class="fas fa-search fa-3x text-muted"></i>
    </div>
    <h4 class="text-main">No se encontraron resultados</h4>
    <p class="text-muted">Intenta con otros términos de búsqueda.</p>
  </div>

</div>

<style>
  /* Custom Styles for this page */
  .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  }

  .bg-gradient-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  }

  .transition-hover {
    transition: all 0.2s ease;
  }

  .transition-hover:hover {
    background: var(--bg-surface-hover);
    transform: translateY(-1px);
  }

  .btn-glass {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .btn-glass:hover {
    background: var(--bg-surface-hover);
    transform: scale(1.1);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filtro = document.getElementById('filtroVentas');
    const rows = document.querySelectorAll('.venta-row');
    const sinResultados = document.getElementById('sinResultados');
    const tablaContainer = document.querySelector('.table-responsive').parentElement;

    filtro.addEventListener('keyup', function () {
      const busqueda = this.value.toLowerCase();
      let visibles = 0;

      rows.forEach(row => {
        const cliente = row.getAttribute('data-cliente') || '';
        const vendedor = row.getAttribute('data-vendedor') || '';
        const id = row.getAttribute('data-id') || '';

        if (cliente.includes(busqueda) || vendedor.includes(busqueda) || id.includes(busqueda)) {
          row.style.display = '';
          visibles++;
        } else {
          row.style.display = 'none';
        }
      });

      if (visibles === 0 && busqueda.length > 0) {
        tablaContainer.classList.add('d-none');
        sinResultados.classList.remove('d-none');
      } else {
        tablaContainer.classList.remove('d-none');
        sinResultados.classList.add('d-none');
      }
    });
  });
</script>
{% endblock %}