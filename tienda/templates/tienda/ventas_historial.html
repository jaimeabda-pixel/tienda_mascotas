{% extends 'tienda/base.html' %}
{% block title %}Historial de Ventas{% endblock %}

{% block content %}

<div class="container-fluid px-0">

  <!-- Header Section -->
  <div class="glass-header mb-4">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0 text-white fw-bold">
          <i class="fas fa-history text-white me-2"></i> Historial de Ventas
        </h1>
        <a href="{% url 'ventas_list' %}" class="btn btn-outline-light btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Volver
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="ventas-container animate__animated animate__fadeIn">

      <div class="glass-card mb-4 p-3">
        <form method="get" class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="fecha_inicio" class="form-label fw-bold" style="color: var(--text-main, #212529);">Fecha
              inicio:</label>
            <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ f_fecha_inicio }}" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="fecha_fin" class="form-label fw-bold" style="color: var(--text-main, #212529);">Fecha
              fin:</label>
            <input type="date" id="fecha_fin" name="fecha_fin" value="{{ f_fecha_fin }}" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="vendedor" class="form-label fw-bold" style="color: var(--text-main, #212529);">Vendedor:</label>
            <select id="vendedor" name="vendedor" class="form-select select2">
              <option value="">Todos</option>
              {% for user in vendedores %}
              <option value="{{ user.id }}" {% if f_vendedor==user.id|stringformat:"s" %}selected{% endif %}>
                {{ user.username }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-grow-1"><i class="fas fa-search me-1"></i>
              Filtrar</button>
            <a href="{% url 'ventas_historial' %}" class="btn btn-outline-secondary flex-grow-1"><i
                class="fas fa-undo me-1"></i> Limpiar</a>
          </div>
        </form>
      </div>

      <div class="table-responsive glass-card p-3">
        <table id="historialTable" class="table table-hover align-middle w-100">
          <thead class="text-center"
            style="background: rgba(0,0,0,0.02); border-bottom: 2px solid var(--border-color, #dee2e6);">
            <tr>
              <th class="py-3 fw-bold" style="color: var(--text-main, #212529);">#Factura</th>
              <th class="py-3 fw-bold" style="color: var(--text-main, #212529);">Fecha</th>
              <th class="py-3 fw-bold" style="color: var(--text-main, #212529);">Cliente</th>
              <th class="py-3 fw-bold" style="color: var(--text-main, #212529);">Vendedor</th>
              <th class="py-3 fw-bold" style="color: var(--text-main, #212529);">Total</th>
              <th class="py-3 fw-bold" style="color: var(--text-main, #212529);">M√©todo de Pago</th>
              <th class="py-3 fw-bold" style="color: var(--text-main, #212529);">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for venta in ventas %}
            <tr style="border-bottom: 1px solid var(--border-color, #dee2e6);">
              <td class="text-center py-3">
                <span class="badge bg-secondary bg-opacity-10 fw-normal" style="color: var(--text-main, #212529);">
                  {{ venta.factura_num }}
                </span>
              </td>
              <td class="text-center py-3" style="color: var(--text-main, #212529);">
                {{ venta.fecha|date:"d/m/Y H:i" }}
              </td>
              <td class="text-center py-3">
                <span class="fw-bold" style="color: var(--text-main, #212529);">{{ venta.cliente.nombre }}</span>
              </td>
              <td class="text-center py-3" style="color: var(--text-main, #212529);">
                {{ venta.vendedor.username }}
              </td>
              <td class="text-center py-3">
                <span class="fw-bold text-success fs-6">${{ venta.total }}</span>
              </td>
              <td class="text-center py-3">
                {% if venta.metodo_pago|lower == 'efectivo' %}
                <span class="badge rounded-pill px-3 py-2"
                  style="background-color: #198754; color: white; font-size: 0.9rem;">
                  <i class="fas fa-money-bill-wave me-1"></i> Efectivo
                </span>
                {% elif venta.metodo_pago|lower == 'tarjeta' %}
                <span class="badge rounded-pill px-3 py-2"
                  style="background-color: #0d6efd; color: white; font-size: 0.9rem;">
                  <i class="fas fa-credit-card me-1"></i> Tarjeta
                </span>
                {% else %}
                <span class="badge rounded-pill px-3 py-2"
                  style="background-color: #6c757d; color: white; font-size: 0.9rem;">
                  {{ venta.metodo_pago|default:"Otro" }}
                </span>
                {% endif %}
              </td>
              <td class="text-center py-3">
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                  <a href="{% url 'ventas_detalle' venta.pk %}" class="btn btn-sm btn-outline-primary rounded-circle"
                    title="Ver Detalle"
                    style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{% url 'ventas_factura_pdf_rl' venta.pk %}"
                    class="btn btn-sm btn-outline-danger rounded-circle" target="_blank" title="Descargar PDF"
                    style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-pdf"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="d-flex flex-column align-items-center opacity-50">
                  <i class="fas fa-receipt fa-3x mb-3" style="color: var(--text-muted, #6c757d);"></i>
                  <h5 style="color: var(--text-muted, #6c757d);">No se encontraron ventas</h5>
                  <p style="color: var(--text-muted, #6c757d);">Intenta ajustar los filtros</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 text-end">
        <h5 class="fw-bold" style="color: var(--text-main, #212529);">
          Total Ventas: <span class="text-success">${{ total_ventas }}</span>
        </h5>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        $('#historialTable').DataTable({
          language: {
            search: "üîç Buscar:",
            lengthMenu: "Mostrar _MENU_ ventas",
            info: "Mostrando _START_ a _END_ de _TOTAL_ ventas",
            paginate: { next: "Siguiente", previous: "Anterior" },
            zeroRecords: "No se encontraron ventas"
          },
          order: [[1, "desc"]],
          pageLength: 10,
          dom: 'Bfrtip',
          buttons: []
        });
      });
    </script>

  </div>
</div>

<style>
  /* Ensure text is readable in both light and dark modes */
  body.light-mode .text-main,
  body.light-mode th,
  body.light-mode h5 {
    color: #212529 !important;
  }

  body.dark-mode .text-main,
  body.dark-mode th,
  body.dark-mode h5 {
    color: #e9ecef !important;
  }

  /* Better hover effect for table rows */
  tbody tr:hover {
    background: var(--bg-surface-hover, rgba(0, 0, 0, 0.02));
  }
</style>

{% endblock %}