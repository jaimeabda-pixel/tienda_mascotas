{% extends 'tienda/base.html' %}
{% load static %}

{% block title %}Punto de Venta PRO{% endblock %}

{% block content %}
<div class="container-fluid h-100 p-0 d-flex" style="overflow: hidden;">

  <!-- Formulario de venta -->
  <div class="flex-grow-1 p-3 glass-card rounded-4 shadow-lg text-light d-flex flex-column">
    <!-- Encabezado: Vendedor y lista de ventas -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div id="vendedor-info"><strong>Vendedor:</strong> {{ user.username }}</div>
      <a href="{% url 'ventas_list' %}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-list me-1"></i> Ver lista de ventas
      </a>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}

    <form method="post" id="venta-form" class="flex-grow-1 d-flex flex-column">
      {% csrf_token %}

      <!-- Código de barras con cantidad -->
      <div class="row g-3 mb-3">
        <div class="col-md-8">
          <label for="codigo_barras" class="form-label">
            <i class="fas fa-barcode me-1"></i> Código de barras
          </label>
          <input type="text" id="codigo_barras" class="form-control rounded-3 shadow-sm" placeholder="Escanea o ingresa el código" autofocus>
        </div>
        <div class="col-md-2">
          <label for="cantidad_codigo" class="form-label">
            <i class="fas fa-sort-numeric-up me-1"></i> Cantidad
          </label>
          <input type="number" id="cantidad_codigo" value="1" min="1" class="form-control rounded-3 shadow-sm">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" class="btn btn-gradient w-100" id="agregarCodigoBtn">
            <i class="fas fa-cart-plus me-1"></i> Agregar
          </button>
        </div>
      </div>

      <!-- Producto y cantidad -->
      <div class="row g-3 mb-3">
        <div class="col-md-8">
          <label for="producto" class="form-label"><i class="fas fa-box me-1"></i> Producto</label>
          <select id="producto" name="producto" class="form-select select2 rounded-3 shadow-sm">
            {% for p in productos %}
              <option value="{{ p.pk }}" data-precio="{{ p.precio }}">
                {{ p.nombre }} - ${{ p.precio }} (Stock: {{ p.stock }})
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <input type="number" id="cantidad" name="cantidad" value="1" min="1" class="form-control rounded-3 shadow-sm me-2">
          <button type="button" id="agregarProducto" class="btn btn-gradient w-100">
            <i class="fas fa-cart-plus me-1"></i> Agregar
          </button>
        </div>
      </div>

      <!-- Cliente y método de pago -->
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="cliente" class="form-label"><i class="fas fa-user me-1"></i> Cliente</label>
          <div class="d-flex gap-2">
            <select id="cliente" name="cliente" class="form-select select2 flex-grow-1 rounded-3 shadow-sm">
              {% for c in clientes %}
                <option value="{{ c.pk }}">{{ c.nombre }}</option>
              {% endfor %}
            </select>
            <button type="button" class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#modalCliente">
              <i class="fas fa-user-plus"></i>
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <label for="metodo_pago" class="form-label"><i class="fas fa-credit-card me-1"></i> Método de pago</label>
          <select id="metodo_pago" name="metodo_pago" class="form-select rounded-3 shadow-sm">
            <option value="Efectivo">Efectivo</option>
            <option value="Tarjeta">Tarjeta</option>
          </select>
        </div>
      </div>

      <!-- Efectivo y vuelto -->
      <div class="row g-3 mb-3" id="efectivo_div">
        <div class="col-md-6">
          <label for="efectivo_recibido" class="form-label"><i class="fas fa-money-bill-wave me-1"></i> Efectivo recibido</label>
          <input type="number" step="0.01" id="efectivo_recibido" name="efectivo_recibido" class="form-control rounded-3 shadow-sm" value="0">
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="fas fa-dollar-sign me-1"></i> Vuelto</label>
          <input type="text" id="vuelto" class="form-control rounded-3 bg-light shadow-sm" readonly>
        </div>
      </div>

      <input type="hidden" id="carrito_data" name="carrito_data">
    </form>
  </div>

  <!-- Panel derecho: carrito -->
  <div class="bg-dark text-light p-3 glass-card rounded-4 shadow-lg d-flex flex-column" style="width: 400px;">
    <h4 class="text-center mb-3">Carrito</h4>
    <div class="flex-grow-1 overflow-auto">
      <table id="carritoTable" class="table table-hover align-middle text-light mb-0">
        <thead class="table-light text-dark text-center">
          <tr>
            <th>Producto</th>
            <th>Precio</th>
            <th>Cant.</th>
            <th>Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- Footer carrito -->
    <div class="mt-3 d-flex justify-content-between align-items-center">
      <h5>Total: <span id="totalVenta" class="text-success">$0</span></h5>
      <button class="btn btn-success px-4" id="registrarVentaBtn">
        <i class="fas fa-check-circle me-1"></i> Pagar
      </button>
    </div>
  </div>

</div>

<!-- Modal nuevo cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1" aria-labelledby="modalClienteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card text-light p-3">
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i> Nuevo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-nuevo-cliente">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Nombre <span class="text-danger">*</span></label>
            <input type="text" id="nombre_cliente" class="form-control form-control-lg" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Correo</label>
            <input type="email" id="correo_cliente" class="form-control form-control-lg">
          </div>
          <div class="mb-3">
            <label class="form-label">Teléfono</label>
            <input type="text" id="telefono_cliente" class="form-control form-control-lg">
          </div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-gradient" id="guardarCliente">Guardar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
jQuery(document).ready(function($){
    $('.select2').select2({ width: '100%' });

    let carrito = [];
    const $producto = $('#producto');
    const $cantidad = $('#cantidad');
    const $metodoPago = $('#metodo_pago');
    const $efectivo = $('#efectivo_recibido');
    const $vuelto = $('#vuelto');

    function calcularVuelto(){
        const total = carrito.reduce((sum,i)=>sum+(i.precio*i.cantidad),0);
        if($metodoPago.val()==='Efectivo'){
            $('#efectivo_div').show();
            const efectivo = parseFloat($efectivo.val())||0;
            const vuelto = efectivo-total;
            $vuelto.val(vuelto>=0?vuelto.toFixed(2):'0.00');
        } else {
            $('#efectivo_div').hide();
            $vuelto.val('0.00');
        }
    }

    function actualizarCarrito(){
        const tbody = $('#carritoTable tbody');
        tbody.empty();
        let total = 0;
        carrito.forEach((item,index)=>{
            const subtotal = item.precio*item.cantidad;
            total+=subtotal;
            tbody.append(`
                <tr>
                  <td>${item.nombre}</td>
                  <td class="text-center">$${item.precio.toLocaleString()}</td>
                  <td class="text-center">${item.cantidad}</td>
                  <td class="text-center text-success">$${subtotal.toLocaleString()}</td>
                  <td class="text-center">
                    <button class="btn btn-danger btn-sm" onclick="eliminarItem(${index})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
            `);
        });
        $('#totalVenta').text('$'+total.toLocaleString());
        calcularVuelto();
    }

    window.eliminarItem=function(index){
        carrito.splice(index,1);
        actualizarCarrito();
    };

    $('#agregarProducto').on('click',function(){
        const id = $producto.val();
        if(!id) return;
        const nombre = $producto.find(':selected').text().split(' - $')[0];
        const precio = parseFloat($producto.find(':selected').data('precio'));
        const cantidad = parseInt($cantidad.val());
        const existente = carrito.find(i=>i.id===id);
        if(existente) existente.cantidad+=cantidad;
        else carrito.push({id,nombre,precio,cantidad});
        actualizarCarrito();
        $cantidad.val(1);
        $producto.val(null).trigger('change');
    });

    // Código de barras
    $('#agregarCodigoBtn').on('click',function(){
        const codigo = $('#codigo_barras').val().trim();
        const cantidad = parseInt($('#cantidad_codigo').val())||1;
        if(!codigo) return;
        $.ajax({
            url:"{% url 'ventas_pos_producto_codigo' %}",
            type:"POST",
            data:{codigo:codigo, csrfmiddlewaretoken:'{{ csrf_token }}'},
            success:function(response){
                if(response.ok){
                    const producto=response.producto;
                    const existente=carrito.find(i=>i.id==producto.id);
                    if(existente) existente.cantidad+=cantidad;
                    else carrito.push({id:producto.id,nombre:producto.nombre,precio:producto.precio,cantidad:cantidad});
                    actualizarCarrito();
                    $('#codigo_barras').val('');
                    $('#cantidad_codigo').val(1);
                    $('#codigo_barras').focus();
                } else alert(response.error);
            }
        });
    });

    $('#codigo_barras,#cantidad_codigo').on('keypress',function(e){
        if(e.which==13){ $('#agregarCodigoBtn').click(); e.preventDefault(); }
    });

    $cantidad.on('input change',calcularVuelto);
    $metodoPago.on('change',calcularVuelto);
    $efectivo.on('input',calcularVuelto);
    if($metodoPago.val()!=='Efectivo') $('#efectivo_div').hide();

    $('#venta-form').on('submit',function(e){
        if(carrito.length===0){ e.preventDefault(); alert("Debes agregar al menos un producto al carrito antes de registrar la venta."); return false; }
        if($metodoPago.val()==='Efectivo'){
            const total=carrito.reduce((sum,i)=>sum+(i.precio*i.cantidad),0);
            const efectivo=parseFloat($efectivo.val())||0;
            if(efectivo<total){ e.preventDefault(); alert(`El efectivo recibido ($${efectivo.toFixed(2)}) es menor al total ($${total.toFixed(2)}).`); return false; }
        }
        // Guardar carrito en hidden input para backend
        $('#carrito_data').val(JSON.stringify(carrito));
    });

    {% if producto_preseleccionado %}
        const preProd=$('#producto').find(':selected');
        if(preProd.length){
            const id=preProd.val();
            const nombre=preProd.text().split(' - $')[0];
            const precio=parseFloat(preProd.data('precio'));
            carrito.push({id,nombre,precio,cantidad:1});
            actualizarCarrito();
        }
    {% endif %}

    $('#registrarVentaBtn').on('click', function() {
        $('#venta-form').submit();
    });
});
</script>
{% endblock %}
