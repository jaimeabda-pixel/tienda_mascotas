{% extends 'tienda/base.html' %}
{% load static %}

{% block title %}Punto de Venta{% endblock %}

{% block container_class %}container-fluid p-0{% endblock %}

{% block content %}
<div class="d-flex flex-column vh-100" style="padding-top: 76px;">

  <!-- Header del POS -->
  <div
    class="px-4 py-3 glass-effect border-bottom border-secondary d-flex justify-content-between align-items-center shadow-sm">
    <div class="d-flex align-items-center gap-4">
      <h4 class="mb-0 text-white fw-bold">
        <i class="fas fa-cash-register text-primary me-2"></i> Punto de Venta
      </h4>
      <div class="d-flex align-items-center text-light opacity-75">
        <i class="fas fa-user-circle me-2"></i>
        <span class="fw-medium">Vendedor: {{ user.username|default:"Usuario" }}</span>
      </div>
    </div>

    <div class="d-flex align-items-center gap-4">
      <div class="text-end d-none d-md-block text-light">
        <div id="current-date" class="small opacity-75"></div>
        <div id="current-time" class="fw-bold text-primary"></div>
      </div>
      <a href="{% url 'ventas_list' %}" class="btn btn-outline-light">
        <i class="fas fa-list-ul me-2"></i> Ver Ventas
      </a>
    </div>
  </div>

  <!-- Contenido Principal -->
  <div class="row g-0 flex-grow-1 overflow-hidden">

    <!-- Columna Izquierda: Productos (7/12) -->
    <div class="col-lg-7 d-flex flex-column h-100 p-4">

      <div class="card glass-card border-secondary shadow-lg mb-4">
        <div class="card-body p-4">
          <form method="post" id="venta-form">
            {% csrf_token %}

            <!-- Buscador y Código -->
            <div class="row g-3 mb-4">
              <div class="col-md-5">
                <label class="form-label text-light small text-uppercase fw-bold">Código de Barras</label>
                <div class="input-group">
                  <span class="input-group-text bg-dark border-secondary text-secondary"><i
                      class="fas fa-barcode"></i></span>
                  <input type="text" id="codigo_barras" class="form-control bg-dark border-secondary text-white"
                    placeholder="Escanear..." autofocus>
                  <input type="number" id="cantidad_codigo" value="1" min="1"
                    class="form-control bg-dark border-secondary text-white text-center" style="max-width: 70px;">
                  <button type="button" class="btn btn-secondary" id="agregarCodigoBtn"><i
                      class="fas fa-plus"></i></button>
                </div>
              </div>

              <div class="col-md-7">
                <label class="form-label text-light small text-uppercase fw-bold">Buscar Producto</label>
                <div class="d-flex gap-2">
                  <div class="flex-grow-1">
                    <select id="producto" name="producto" class="form-select select2-dark">
                      <option value="">Buscar producto...</option>
                      {% for p in productos %}
                      <option value="{{ p.pk }}" data-precio="{{ p.precio }}">
                        {{ p.nombre }} - ${{ p.precio }} (Stock: {{ p.stock }})
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <input type="number" id="cantidad" name="cantidad" value="1" min="1"
                    class="form-control bg-dark border-secondary text-white text-center" style="width: 70px;">
                  <button type="button" id="agregarProducto" class="btn btn-primary"><i
                      class="fas fa-cart-plus"></i></button>
                </div>
              </div>
            </div>

            <hr class="border-secondary opacity-50">

            <!-- Cliente y Pago -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label text-light small text-uppercase fw-bold">Cliente</label>
                <div class="input-group">
                  <select id="cliente" name="cliente" class="form-select select2-dark">
                    <option value="">Cliente General</option>
                    {% for c in clientes %}
                    <option value="{{ c.pk }}">{{ c.nombre }}</option>
                    {% endfor %}
                  </select>
                  <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                    data-bs-target="#modalCliente">
                    <i class="fas fa-user-plus"></i>
                  </button>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label text-light small text-uppercase fw-bold">Método de Pago</label>
                <div class="d-flex gap-2">
                  <div class="flex-fill">
                    <input type="radio" class="btn-check" name="metodo_pago_radio" id="pago_efectivo" value="Efectivo"
                      checked>
                    <label class="btn btn-outline-success w-100" for="pago_efectivo">
                      <i class="fas fa-money-bill-wave me-2"></i>Efectivo
                    </label>
                  </div>
                  <div class="flex-fill">
                    <input type="radio" class="btn-check" name="metodo_pago_radio" id="pago_tarjeta" value="Tarjeta">
                    <label class="btn btn-outline-info w-100" for="pago_tarjeta">
                      <i class="fas fa-credit-card me-2"></i>Tarjeta
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Panel Efectivo -->
            <div id="efectivo_div"
              class="row mt-4 g-3 p-3 rounded bg-black bg-opacity-25 border border-secondary border-opacity-25 mx-1"
              style="display: none;">
              <div class="col-md-6">
                <label class="form-label text-success fw-bold">Efectivo Recibido</label>
                <div class="input-group input-group-lg">
                  <span class="input-group-text bg-success border-success text-white">$</span>
                  <input type="number" step="0.01" id="efectivo_recibido" name="efectivo_recibido"
                    class="form-control bg-dark border-success text-white" placeholder="0.00">
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-light fw-bold">Vuelto</label>
                <div class="input-group input-group-lg">
                  <span class="input-group-text bg-secondary border-secondary text-white">$</span>
                  <input type="text" id="vuelto" class="form-control bg-dark border-secondary text-white" readonly
                    placeholder="0.00">
                </div>
              </div>
            </div>

            <input type="hidden" id="metodo_pago" name="metodo_pago">
            <input type="hidden" id="carrito_data" name="carrito_data">
          </form>
        </div>
      </div>
    </div>

    <!-- Columna Derecha: Carrito (5/12) -->
    <div class="col-lg-5 d-flex flex-column h-100 glass-effect border-start border-secondary shadow-lg">

      <div class="p-4 border-bottom border-secondary">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-white fw-bold">
            <i class="fas fa-shopping-basket me-2 text-primary"></i> Carrito de Compras
          </h5>
          <span class="badge bg-primary rounded-pill fs-6" id="cart-count">0</span>
        </div>
      </div>

      <!-- Lista de Items -->
      <div class="flex-grow-1 overflow-auto p-0 custom-scrollbar">
        <div id="empty-cart"
          class="d-flex flex-column align-items-center justify-content-center h-100 text-secondary opacity-50">
          <i class="fas fa-shopping-cart fa-4x mb-3"></i>
          <p class="fs-5">El carrito está vacío</p>
        </div>

        <div id="cart-table-container" style="display: none;">
          <table class="table table-glass table-hover align-middle mb-0" id="carritoTable">
            <thead class="table-light text-dark sticky-top">
              <tr>
                <th class="ps-4">Producto</th>
                <th class="text-center">Cant.</th>
                <th class="text-end pe-4">Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody class="border-top-0"></tbody>
          </table>
        </div>
      </div>

      <!-- Footer Totales -->
      <div class="p-4 border-top border-secondary">
        <div class="d-flex justify-content-between align-items-end mb-4">
          <span class="text-secondary text-uppercase small fw-bold">Total a Pagar</span>
          <h1 class="mb-0 fw-bold text-primary display-5" id="totalVenta">$0</h1>
        </div>
        <button class="btn btn-success w-100 py-3 fw-bold fs-5 shadow-lg" id="registrarVentaBtn" disabled>
          <i class="fas fa-check-circle me-2"></i> PROCESAR VENTA
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Mensajes -->
<div class="messages-container position-fixed top-0 end-0 p-3" style="z-index: 1060; margin-top: 80px;"></div>

<!-- Modal Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark border border-secondary text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i> Nuevo Cliente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-nuevo-cliente">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Nombre <span class="text-danger">*</span></label>
            <input type="text" id="nombre_cliente" class="form-control bg-dark border-secondary text-white" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Correo</label>
            <input type="email" id="correo_cliente" class="form-control bg-dark border-secondary text-white">
          </div>
          <div class="mb-3">
            <label class="form-label">Teléfono</label>
            <input type="text" id="telefono_cliente" class="form-control bg-dark border-secondary text-white">
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="guardarCliente">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tarjeta -->
<div class="modal fade" id="modalTarjeta" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark border border-secondary text-white text-center p-5">
      <h3 class="mb-4 text-info"><i class="fas fa-credit-card me-2"></i> Pago con Tarjeta</h3>
      <div id="posAnimacion">
        <div class="spinner-border text-info mb-3" style="width: 3rem; height: 3rem;"></div>
        <p class="text-muted">Esperando tarjeta...</p>
      </div>
      <div id="posAprobado" style="display:none;">
        <i class="fas fa-check-circle text-success mb-3" style="font-size: 5rem;"></i>
        <h4 class="text-success">¡Aprobado!</h4>
      </div>
      <div id="posRechazado" style="display:none;">
        <i class="fas fa-times-circle text-danger mb-3" style="font-size: 5rem;"></i>
        <h4 class="text-danger">Rechazado</h4>
      </div>
    </div>
  </div>
</div>

<style>
  /* Custom Scrollbar */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: #1a1f2e;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #4a5568;
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #718096;
  }

  /* Select2 Dark Theme Customization */
  .select2-container--default .select2-selection--single {
    background-color: #212529 !important;
    border-color: #6c757d !important;
    height: 38px !important;
  }

  .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #fff !important;
    line-height: 36px !important;
  }

  .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px !important;
  }

  .select2-dropdown {
    background-color: #212529 !important;
    border-color: #6c757d !important;
    color: #fff !important;
  }

  .select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #0d6efd !important;
  }

  .select2-container--default .select2-results__option[aria-selected=true] {
    background-color: #343a40 !important;
  }
</style>

{% endblock %}

{% block extra_js %}
<script>
  jQuery(document).ready(function ($) {
    // Update Date/Time
    function updateDateTime() {
      const now = new Date();
      $('#current-date').text(now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
      $('#current-time').text(now.toLocaleTimeString('es-ES'));
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Init Select2
    $('.select2-dark').select2({
      width: '100%',
      dropdownParent: $('body'),
      language: { noResults: () => "No encontrado" }
    });

    // Cart Logic
    let carrito = [];
    const $producto = $('#producto');
    const $cantidad = $('#cantidad');
    const $metodoPago = $('#metodo_pago');
    const $efectivo = $('#efectivo_recibido');
    const $vuelto = $('#vuelto');

    function calcularVuelto() {
      const total = carrito.reduce((sum, i) => sum + (i.precio * i.cantidad), 0);
      const metodoPago = $('input[name="metodo_pago_radio"]:checked').val();
      if (metodoPago === 'Efectivo') {
        $('#efectivo_div').slideDown();
        const efectivo = parseFloat($efectivo.val()) || 0;
        const vuelto = efectivo - total;
        $vuelto.val(vuelto >= 0 ? vuelto.toFixed(2) : '0.00');
      } else {
        $('#efectivo_div').slideUp();
        $vuelto.val('0.00');
      }
    }

    function actualizarCarrito() {
      const tbody = $('#carritoTable tbody');
      tbody.empty();
      let total = 0;

      if (carrito.length === 0) {
        $('#empty-cart').removeClass('d-none').addClass('d-flex');
        $('#cart-table-container').hide();
        $('#cart-count').text('0');
        $('#registrarVentaBtn').prop('disabled', true);
      } else {
        $('#empty-cart').removeClass('d-flex').addClass('d-none');
        $('#cart-table-container').show();
        $('#cart-count').text(carrito.length);
        $('#registrarVentaBtn').prop('disabled', false);
      }

      carrito.forEach((item, index) => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        tbody.append(`
                <tr>
                  <td class="ps-4">
                    <div class="fw-bold text-white text-truncate" style="max-width: 180px;" title="${item.nombre}">${item.nombre}</div>
                    <small class="text-muted">$${item.precio.toLocaleString()}</small>
                  </td>
                  <td class="text-center text-white">${item.cantidad}</td>
                  <td class="text-end pe-4 fw-bold text-primary">$${subtotal.toLocaleString()}</td>
                  <td class="text-end pe-3">
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="eliminarItem(${index})" title="Eliminar">
                      <i class="fas fa-times"></i>
                    </button>
                  </td>
                </tr>
            `);
      });

      $('#totalVenta').text('$' + total.toLocaleString());
      calcularVuelto();
      $metodoPago.val($('input[name="metodo_pago_radio"]:checked').val());
    }

    window.eliminarItem = function (index) {
      carrito.splice(index, 1);
      actualizarCarrito();
    };

    $('#agregarProducto').on('click', function () {
      const id = $producto.val();
      if (!id) { showNotification('Selecciona un producto', 'warning'); return; }
      const nombre = $producto.find(':selected').text().split(' - $')[0];
      const precio = parseFloat($producto.find(':selected').data('precio'));
      const cantidad = parseInt($cantidad.val()) || 1;

      if (cantidad < 1) { showNotification('Cantidad inválida', 'warning'); return; }

      const existente = carrito.find(i => i.id === id);
      if (existente) {
        existente.cantidad += cantidad;
        showNotification(`Actualizado: ${nombre}`, 'success');
      } else {
        carrito.push({ id, nombre, precio, cantidad });
        showNotification(`Agregado: ${nombre}`, 'success');
      }
      actualizarCarrito();
      $cantidad.val(1);
      $producto.val(null).trigger('change');
    });

    $('#agregarCodigoBtn').on('click', function () {
      const codigo = $('#codigo_barras').val().trim();
      const cantidad = parseInt($('#cantidad_codigo').val()) || 1;
      if (!codigo) { showNotification('Ingresa código', 'warning'); return; }

      $.ajax({
        url: "{% url 'ventas_pos_producto_codigo' %}",
        type: "POST",
        data: { codigo: codigo, csrfmiddlewaretoken: '{{ csrf_token }}' },
        success: function (response) {
          if (response.ok) {
            const p = response.producto;
            const ex = carrito.find(i => i.id == p.id);
            if (ex) ex.cantidad += cantidad;
            else carrito.push({ id: p.id, nombre: p.nombre, precio: p.precio, cantidad: cantidad });

            showNotification(`Agregado: ${p.nombre}`, 'success');
            actualizarCarrito();
            $('#codigo_barras').val('').focus();
            $('#cantidad_codigo').val(1);
          } else {
            showNotification(response.error, 'danger');
          }
        },
        error: function () { showNotification('Error al buscar', 'danger'); }
      });
    });

    $('#codigo_barras,#cantidad_codigo').on('keypress', function (e) {
      if (e.which == 13) { $('#agregarCodigoBtn').click(); e.preventDefault(); }
    });
    $('#cantidad').on('keypress', function (e) {
      if (e.which == 13) { $('#agregarProducto').click(); e.preventDefault(); }
    });

    $('input[name="metodo_pago_radio"]').on('change', function () {
      calcularVuelto();
      $metodoPago.val($(this).val());
    });
    $cantidad.on('input change', calcularVuelto);
    $efectivo.on('input', calcularVuelto);

    function showNotification(msg, type) {
      const icon = type === 'success' ? 'fa-check' : type === 'danger' ? 'fa-times' : 'fa-info';
      const alert = $(`
            <div class="alert alert-${type} shadow-lg text-white border-0 d-flex align-items-center" style="background: ${type === 'success' ? '#198754' : type === 'danger' ? '#dc3545' : '#ffc107'}; opacity: 0.9;">
                <i class="fas ${icon} me-2"></i> ${msg}
            </div>
        `);
      $('.messages-container').append(alert);
      setTimeout(() => alert.fadeOut(() => alert.remove()), 3000);
    }

    $('#venta-form').on('submit', function (e) {
      if (carrito.length === 0) { e.preventDefault(); showNotification("Carrito vacío", "danger"); return false; }
      const metodo = $('input[name="metodo_pago_radio"]:checked').val();
      if (metodo === 'Efectivo') {
        const total = carrito.reduce((sum, i) => sum + (i.precio * i.cantidad), 0);
        const ef = parseFloat($efectivo.val()) || 0;
        if (ef < total) { e.preventDefault(); showNotification("Efectivo insuficiente", "danger"); return false; }
      }
      $('#registrarVentaBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Procesando...');
      $('#carrito_data').val(JSON.stringify(carrito));
    });

    {% if producto_preseleccionado %}
    setTimeout(() => {
      $('#producto').val('{{ producto_preseleccionado.pk }}').trigger('change');
      $('#agregarProducto').click();
    }, 500);
    {% endif %}

    $('#registrarVentaBtn').on('click', function () {
      if ($('input[name="metodo_pago_radio"]:checked').val() === "Tarjeta") {
        const modal = new bootstrap.Modal(document.getElementById('modalTarjeta'));
        modal.show();
        $('#posAnimacion').show(); $('#posAprobado').hide();
        setTimeout(() => {
          $('#posAnimacion').hide(); $('#posAprobado').show();
          setTimeout(() => { modal.hide(); $('#venta-form').submit(); }, 1000);
        }, 2000);
      } else {
        $('#venta-form').submit();
      }
    });

    $('#guardarCliente').on('click', function () {
      const nombre = $('#nombre_cliente').val().trim();
      if (!nombre) { showNotification("Nombre requerido", "danger"); return; }
      $(this).prop('disabled', true);
      $.ajax({
        url: "{% url 'cliente_add_ajax' %}",
        type: "POST",
        data: {
          nombre: nombre,
          correo: $('#correo_cliente').val(),
          telefono: $('#telefono_cliente').val(),
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (res) {
          const opt = new Option(res.nombre, res.id, true, true);
          $('#cliente').append(opt).trigger('change');
          $('#modalCliente').modal('hide');
          $('#form-nuevo-cliente')[0].reset();
          showNotification('Cliente creado', 'success');
          $('#guardarCliente').prop('disabled', false);
        },
        error: function () {
          showNotification('Error al crear cliente', 'danger');
          $('#guardarCliente').prop('disabled', false);
        }
      });
    });
  });
</script>
{% endblock %}