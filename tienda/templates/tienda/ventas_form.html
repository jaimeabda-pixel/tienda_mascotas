{% extends 'tienda/base.html' %}
{% load static %}

{% block title %}Punto de Venta{% endblock %}

{% block container_class %}container-fluid p-0 overflow-hidden{% endblock %}

{% block content %}
<style>
  /* Hide default Navbar and Footer for full-screen POS experience */
  #mainNav,
  footer {
    display: none !important;
  }

  /* POS Specific Styles */
  :root {
    --pos-bg: #0f172a;
    --pos-panel-bg: rgba(30, 41, 59, 0.7);
    --pos-border: rgba(255, 255, 255, 0.1);
    --pos-accent: #3b82f6;
    --pos-success: #10b981;
    --pos-text: #f8fafc;
    --pos-text-muted: #94a3b8;
  }

  body {
    background-color: var(--pos-bg);
    color: var(--pos-text);
    overflow: hidden;
    /* Prevent body scroll */
  }

  .pos-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: radial-gradient(circle at top right, #1e293b, #0f172a);
  }

  .pos-header {
    height: 60px;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--pos-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    z-index: 100;
  }

  .glass-panel {
    background: var(--pos-panel-bg);
    backdrop-filter: blur(12px);
    border: 1px solid var(--pos-border);
    border-radius: 16px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  }

  .pos-input {
    background: rgba(0, 0, 0, 0.3) !important;
    border: 1px solid var(--pos-border) !important;
    color: var(--pos-text) !important;
    height: 50px;
    font-size: 1.1rem;
  }

  .pos-input:focus {
    border-color: var(--pos-accent) !important;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3) !important;
  }

  .btn-pos-action {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.2s;
  }

  .btn-pos-action:hover {
    transform: translateY(-2px);
  }

  .cart-item {
    transition: background 0.2s;
    border-bottom: 1px solid var(--pos-border);
  }

  .cart-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .total-display {
    font-family: 'Courier New', monospace;
    /* Receipt style font */
    letter-spacing: -1px;
  }

  /* Select2 Customization for POS */
  .select2-container--default .select2-selection--single {
    background-color: rgba(0, 0, 0, 0.3) !important;
    border: 1px solid var(--pos-border) !important;
    height: 50px !important;
    border-radius: 0.375rem !important;
  }

  .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: var(--pos-text) !important;
    line-height: 48px !important;
    font-size: 1.1rem;
  }

  .select2-dropdown {
    background-color: #1e293b !important;
    border: 1px solid var(--pos-border) !important;
  }

  .select2-search__field {
    background-color: rgba(0, 0, 0, 0.3) !important;
    color: white !important;
  }

  .select2-results__option {
    color: #cbd5e1 !important;
  }

  .select2-results__option--highlighted {
    background-color: var(--pos-accent) !important;
    color: white !important;
  }

  /* Custom Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
  }
</style>

<div class="pos-container">
  <!-- Header -->
  <div class="pos-header">
    <div class="d-flex align-items-center gap-3">
      <div class="bg-primary bg-opacity-25 p-2 rounded-circle text-primary">
        <i class="fas fa-cash-register fa-lg"></i>
      </div>
      <div>
        <h5 class="mb-0 fw-bold text-white">Punto de Venta</h5>
        <small class="text-muted"><i class="fas fa-user me-1"></i> {{ user.username }}</small>
      </div>
    </div>

    <div class="d-flex align-items-center gap-4">
      <div class="text-end d-none d-md-block">
        <div id="current-time" class="fw-bold fs-5 text-white"></div>
        <div id="current-date" class="small text-muted"></div>
      </div>
      <a href="{% url 'ventas_list' %}" class="btn btn-outline-light btn-sm rounded-pill px-3">
        <i class="fas fa-sign-out-alt me-2"></i> Salir
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row g-0 flex-grow-1 overflow-hidden">

    <!-- Left Panel: Input & Controls -->
    <div class="col-lg-7 d-flex flex-column p-3 p-lg-4 gap-3 overflow-auto">

      <!-- Product Entry Section -->
      <div class="glass-panel p-4">
        <form method="post" id="venta-form">
          {% csrf_token %}

          <div class="row g-3">
            <!-- Barcode Scanner -->
            <div class="col-12">
              <label class="form-label text-muted small text-uppercase fw-bold mb-1">Escáner / Código</label>
              <div class="input-group">
                <span class="input-group-text bg-dark border-secondary text-muted"><i class="fas fa-barcode"></i></span>
                <input type="text" id="codigo_barras" class="form-control pos-input"
                  placeholder="Escanear código de barras..." autofocus>
                <input type="number" id="cantidad_codigo" value="1" min="1" class="form-control pos-input text-center"
                  style="max-width: 80px;">
                <button type="button" class="btn btn-primary btn-pos-action px-4" id="agregarCodigoBtn">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>

            <!-- Manual Search -->
            <div class="col-12">
              <label class="form-label text-muted small text-uppercase fw-bold mb-1">Búsqueda Manual</label>
              <div class="d-flex gap-2">
                <div class="flex-grow-1">
                  <select id="producto" name="producto" class="form-select select2-dark">
                    <option value="">Buscar por nombre...</option>
                    {% for p in productos %}
                    <option value="{{ p.pk }}" data-precio="{{ p.precio }}">
                      {{ p.nombre }} - ${{ p.precio }} (Stock: {{ p.stock }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <input type="number" id="cantidad" name="cantidad" value="1" min="1"
                  class="form-control pos-input text-center" style="width: 80px;">
                <button type="button" id="agregarProducto" class="btn btn-secondary btn-pos-action px-4">
                  <i class="fas fa-search-plus"></i>
                </button>
              </div>
            </div>
          </div>

          <hr class="border-secondary opacity-25 my-4">

          <!-- Customer & Payment -->
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label text-muted small text-uppercase fw-bold mb-1">Cliente</label>
              <div class="input-group">
                <select id="cliente" name="cliente" class="form-select select2-dark">
                  <option value="">Cliente General</option>
                  {% for c in clientes %}
                  <option value="{{ c.pk }}">{{ c.nombre }}</option>
                  {% endfor %}
                </select>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
                  data-bs-target="#modalCliente">
                  <i class="fas fa-user-plus"></i>
                </button>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label text-muted small text-uppercase fw-bold mb-1">Método de Pago</label>
              <div class="d-flex gap-2">
                <div class="flex-fill">
                  <input type="radio" class="btn-check" name="metodo_pago_radio" id="pago_efectivo" value="Efectivo"
                    checked>
                  <label class="btn btn-outline-success w-100 btn-pos-action" for="pago_efectivo">
                    <i class="fas fa-money-bill-wave me-2"></i>Efectivo
                  </label>
                </div>
                <div class="flex-fill">
                  <input type="radio" class="btn-check" name="metodo_pago_radio" id="pago_tarjeta" value="Tarjeta">
                  <label class="btn btn-outline-info w-100 btn-pos-action" for="pago_tarjeta">
                    <i class="fas fa-credit-card me-2"></i>Tarjeta
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Cash Calculation Panel -->
          <div id="efectivo_div"
            class="mt-4 p-3 rounded bg-dark bg-opacity-50 border border-secondary border-opacity-25">
            <div class="row g-3">
              <div class="col-6">
                <label class="text-success fw-bold small text-uppercase">Recibido</label>
                <div class="input-group">
                  <span class="input-group-text bg-success border-success text-white border-0">$</span>
                  <input type="number" step="0.01" id="efectivo_recibido" name="efectivo_recibido"
                    class="form-control pos-input border-0" placeholder="0.00">
                </div>
              </div>
              <div class="col-6">
                <label class="text-white fw-bold small text-uppercase">Vuelto</label>
                <div class="input-group">
                  <span class="input-group-text bg-secondary border-secondary text-white border-0">$</span>
                  <input type="text" id="vuelto" class="form-control pos-input border-0 bg-transparent" readonly
                    placeholder="0.00">
                </div>
              </div>
            </div>
          </div>

          <input type="hidden" id="metodo_pago" name="metodo_pago">
          <input type="hidden" id="carrito_data" name="carrito_data">
        </form>
      </div>

      <!-- Quick Info / Instructions (Optional filler) -->
      <div class="mt-auto text-center text-muted opacity-50 small">
        <p class="mb-0">Sistema de Punto de Venta v2.0 &bull; Tienda Mascotas</p>
        <p>Use el escáner o busque manualmente para agregar productos.</p>
      </div>
    </div>

    <!-- Right Panel: Cart & Totals -->
    <div
      class="col-lg-5 d-flex flex-column h-100 bg-dark border-start border-secondary border-opacity-25 shadow-lg position-relative">

      <!-- Cart Header -->
      <div
        class="p-3 border-bottom border-secondary border-opacity-25 bg-black bg-opacity-20 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-white fw-bold"><i class="fas fa-shopping-basket me-2 text-warning"></i> Carrito</h5>
        <span class="badge bg-warning text-dark rounded-pill fs-6 px-3" id="cart-count">0 Items</span>
      </div>

      <!-- Cart List -->
      <div class="flex-grow-1 overflow-auto custom-scrollbar position-relative" style="background: rgba(0,0,0,0.2);">
        <div id="empty-cart"
          class="d-flex flex-column align-items-center justify-content-center h-100 text-muted opacity-25">
          <i class="fas fa-shopping-cart fa-5x mb-3"></i>
          <p class="fs-4">Carrito Vacío</p>
        </div>

        <div id="cart-table-container" style="display: none;">
          <table class="table table-dark table-hover align-middle mb-0" id="carritoTable"
            style="--bs-table-bg: transparent;">
            <thead class="text-secondary small text-uppercase"
              style="background: rgba(0,0,0,0.4); position: sticky; top: 0;">
              <tr>
                <th class="ps-4 py-3">Producto</th>
                <th class="text-center py-3">Cant.</th>
                <th class="text-end pe-4 py-3">Subtotal</th>
                <th class="py-3"></th>
              </tr>
            </thead>
            <tbody class="border-top-0"></tbody>
          </table>
        </div>
      </div>

      <!-- Totals Section -->
      <div class="p-4 bg-black bg-opacity-40 border-top border-secondary border-opacity-25">
        <div class="d-flex justify-content-between align-items-end mb-2">
          <span class="text-muted text-uppercase fw-bold">Total a Pagar</span>
        </div>
        <div class="text-end mb-4">
          <h1 class="mb-0 fw-bold text-success display-3 total-display" id="totalVenta">$0</h1>
        </div>

        <button class="btn btn-success w-100 py-4 fw-bold fs-4 shadow-lg text-uppercase rounded-3"
          id="registrarVentaBtn" disabled style="background: linear-gradient(45deg, #10b981, #059669); border: none;">
          <i class="fas fa-check-circle me-2"></i> Cobrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Mensajes -->
<div class="messages-container position-fixed top-0 end-0 p-3" style="z-index: 2000; margin-top: 10px;"></div>

<!-- Modal Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i> Nuevo Cliente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-nuevo-cliente">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Nombre <span class="text-danger">*</span></label>
            <input type="text" id="nombre_cliente" class="form-control bg-secondary text-white border-0" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Correo</label>
            <input type="email" id="correo_cliente" class="form-control bg-secondary text-white border-0">
          </div>
          <div class="mb-3">
            <label class="form-label">Teléfono</label>
            <input type="text" id="telefono_cliente" class="form-control bg-secondary text-white border-0">
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="guardarCliente">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tarjeta -->
<div class="modal fade" id="modalTarjeta" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border border-secondary text-center p-5">
      <h3 class="mb-4 text-info"><i class="fas fa-credit-card me-2"></i> Pago con Tarjeta</h3>
      <div id="posAnimacion">
        <div class="spinner-border text-info mb-3" style="width: 3rem; height: 3rem;"></div>
        <p class="text-muted">Esperando tarjeta...</p>
      </div>
      <div id="posAprobado" style="display:none;">
        <i class="fas fa-check-circle text-success mb-3" style="font-size: 5rem;"></i>
        <h4 class="text-success">¡Aprobado!</h4>
      </div>
      <div id="posRechazado" style="display:none;">
        <i class="fas fa-times-circle text-danger mb-3" style="font-size: 5rem;"></i>
        <h4 class="text-danger">Rechazado</h4>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  jQuery(document).ready(function ($) {
    // Update Date/Time
    function updateDateTime() {
      const now = new Date();
      $('#current-date').text(now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
      $('#current-time').text(now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }));
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Init Select2
    $('.select2-dark').select2({
      width: '100%',
      dropdownParent: $('body'),
      language: { noResults: () => "No encontrado" }
    });

    // Cart Logic
    let carrito = [];
    const $producto = $('#producto');
    const $cantidad = $('#cantidad');
    const $metodoPago = $('#metodo_pago');
    const $efectivo = $('#efectivo_recibido');
    const $vuelto = $('#vuelto');

    function calcularVuelto() {
      const total = carrito.reduce((sum, i) => sum + (i.precio * i.cantidad), 0);
      const metodoPago = $('input[name="metodo_pago_radio"]:checked').val();

      if (metodoPago === 'Efectivo') {
        $('#efectivo_div').slideDown();
        const efectivo = parseFloat($efectivo.val()) || 0;
        const vuelto = efectivo - total;
        $vuelto.val(vuelto >= 0 ? vuelto.toFixed(2) : '0.00');
      } else {
        $('#efectivo_div').slideUp();
        $vuelto.val('0.00');
      }
    }

    function actualizarCarrito() {
      const tbody = $('#carritoTable tbody');
      tbody.empty();
      let total = 0;

      if (carrito.length === 0) {
        $('#empty-cart').removeClass('d-none').addClass('d-flex');
        $('#cart-table-container').hide();
        $('#cart-count').text('0 Items');
        $('#registrarVentaBtn').prop('disabled', true);
      } else {
        $('#empty-cart').removeClass('d-flex').addClass('d-none');
        $('#cart-table-container').show();
        $('#cart-count').text(carrito.length + (carrito.length === 1 ? ' Item' : ' Items'));
        $('#registrarVentaBtn').prop('disabled', false);
      }

      carrito.forEach((item, index) => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        tbody.append(`
                <tr class="cart-item">
                  <td class="ps-4">
                    <div class="fw-bold text-white text-truncate" style="max-width: 180px;" title="${item.nombre}">${item.nombre}</div>
                    <small class="text-muted">$${item.precio.toLocaleString()}</small>
                  </td>
                  <td class="text-center text-white">${item.cantidad}</td>
                  <td class="text-end pe-4 fw-bold text-info">$${subtotal.toLocaleString()}</td>
                  <td class="text-end pe-3">
                    <button class="btn btn-sm btn-outline-danger border-0 rounded-circle" onclick="eliminarItem(${index})" title="Eliminar">
                      <i class="fas fa-times"></i>
                    </button>
                  </td>
                </tr>
            `);
      });

      $('#totalVenta').text('$' + total.toLocaleString());
      calcularVuelto();
      $metodoPago.val($('input[name="metodo_pago_radio"]:checked').val());
    }

    window.eliminarItem = function (index) {
      carrito.splice(index, 1);
      actualizarCarrito();
    };

    $('#agregarProducto').on('click', function () {
      const id = $producto.val();
      if (!id) { showNotification('Selecciona un producto', 'warning'); return; }
      const nombre = $producto.find(':selected').text().split(' - $')[0];
      const precio = parseFloat($producto.find(':selected').data('precio'));
      const cantidad = parseInt($cantidad.val()) || 1;

      if (cantidad < 1) { showNotification('Cantidad inválida', 'warning'); return; }

      const existente = carrito.find(i => i.id === id);
      if (existente) {
        existente.cantidad += cantidad;
        showNotification(`Actualizado: ${nombre}`, 'success');
      } else {
        carrito.push({ id, nombre, precio, cantidad });
        showNotification(`Agregado: ${nombre}`, 'success');
      }
      actualizarCarrito();
      $cantidad.val(1);
      $producto.val(null).trigger('change');
    });

    $('#agregarCodigoBtn').on('click', function () {
      const codigo = $('#codigo_barras').val().trim();
      const cantidad = parseInt($('#cantidad_codigo').val()) || 1;
      if (!codigo) { showNotification('Ingresa código', 'warning'); return; }

      $.ajax({
        url: "{% url 'ventas_pos_producto_codigo' %}",
        type: "POST",
        data: { codigo: codigo, csrfmiddlewaretoken: '{{ csrf_token }}' },
        success: function (response) {
          if (response.ok) {
            const p = response.producto;
            const ex = carrito.find(i => i.id == p.id);
            if (ex) ex.cantidad += cantidad;
            else carrito.push({ id: p.id, nombre: p.nombre, precio: p.precio, cantidad: cantidad });

            showNotification(`Agregado: ${p.nombre}`, 'success');
            actualizarCarrito();
            $('#codigo_barras').val('').focus();
            $('#cantidad_codigo').val(1);
          } else {
            showNotification(response.error, 'danger');
          }
        },
        error: function () { showNotification('Error al buscar', 'danger'); }
      });
    });

    $('#codigo_barras,#cantidad_codigo').on('keypress', function (e) {
      if (e.which == 13) { $('#agregarCodigoBtn').click(); e.preventDefault(); }
    });
    $('#cantidad').on('keypress', function (e) {
      if (e.which == 13) { $('#agregarProducto').click(); e.preventDefault(); }
    });

    $('input[name="metodo_pago_radio"]').on('change', function () {
      calcularVuelto();
      $metodoPago.val($(this).val());
    });
    $cantidad.on('input change', calcularVuelto);
    $efectivo.on('input', calcularVuelto);

    // Initial call to set correct visibility based on default checked radio
    calcularVuelto();

    function showNotification(msg, type) {
      const icon = type === 'success' ? 'fa-check' : type === 'danger' ? 'fa-times' : 'fa-info';
      const alert = $(`
            <div class="alert alert-${type} shadow-lg text-white border-0 d-flex align-items-center animate__animated animate__fadeInRight" style="background: ${type === 'success' ? '#10b981' : type === 'danger' ? '#ef4444' : '#f59e0b'}; opacity: 0.95; border-radius: 10px;">
                <i class="fas ${icon} me-2"></i> ${msg}
            </div>
        `);
      $('.messages-container').append(alert);
      setTimeout(() => alert.fadeOut(() => alert.remove()), 3000);
    }

    $('#venta-form').on('submit', function (e) {
      if (carrito.length === 0) { e.preventDefault(); showNotification("Carrito vacío", "danger"); return false; }
      const metodo = $('input[name="metodo_pago_radio"]:checked').val();
      if (metodo === 'Efectivo') {
        const total = carrito.reduce((sum, i) => sum + (i.precio * i.cantidad), 0);
        const ef = parseFloat($efectivo.val()) || 0;
        if (ef < total) { e.preventDefault(); showNotification("Efectivo insuficiente", "danger"); return false; }
      }
      $('#registrarVentaBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Procesando...');
      $('#carrito_data').val(JSON.stringify(carrito));
    });

    {% if producto_preseleccionado %}
    setTimeout(() => {
      $('#producto').val('{{ producto_preseleccionado.pk }}').trigger('change');
      $('#agregarProducto').click();
    }, 500);
    {% endif %}

    $('#registrarVentaBtn').on('click', function () {
      if ($('input[name="metodo_pago_radio"]:checked').val() === "Tarjeta") {
        const modal = new bootstrap.Modal(document.getElementById('modalTarjeta'));
        modal.show();
        $('#posAnimacion').show(); $('#posAprobado').hide();
        setTimeout(() => {
          $('#posAnimacion').hide(); $('#posAprobado').show();
          setTimeout(() => { modal.hide(); $('#venta-form').submit(); }, 1000);
        }, 2000);
      } else {
        $('#venta-form').submit();
      }
    });

    $('#guardarCliente').on('click', function () {
      const nombre = $('#nombre_cliente').val().trim();
      if (!nombre) { showNotification("Nombre requerido", "danger"); return; }
      $(this).prop('disabled', true);
      $.ajax({
        url: "{% url 'cliente_add_ajax' %}",
        type: "POST",
        data: {
          nombre: nombre,
          correo: $('#correo_cliente').val(),
          telefono: $('#telefono_cliente').val(),
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (res) {
          const opt = new Option(res.nombre, res.id, true, true);
          $('#cliente').append(opt).trigger('change');
          $('#modalCliente').modal('hide');
          $('#form-nuevo-cliente')[0].reset();
          showNotification('Cliente creado', 'success');
          $('#guardarCliente').prop('disabled', false);
        },
        error: function () {
          showNotification('Error al crear cliente', 'danger');
          $('#guardarCliente').prop('disabled', false);
        }
      });
    });
  });
</script>
{% endblock %}